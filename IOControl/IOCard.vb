Option Strict Off
Option Explicit On
<System.Runtime.InteropServices.ProgId("IOCard_NET.IOCard")> Public Class IOCard
	'******************************************************************************
	'** 文件名：IOCard.cls
	'** 版  权：CopyRight (c) 2009-2011 武汉华信数据系统有限公司
	'** 创建人：hexiaoqin
	'** 邮  箱：
	'** 日  期：2009-03-05
	'** 修改人：
	'** 日  期：2009-03-05
	'** 描  述：
	'**
	'** 版  本：1.0
	'******************************************************************************
	'Option Explicit
	Private DIWordState(15) As Boolean '用于接收输入的状态
	Private DIState(15) As Boolean '用于接收输入的状态
	Private TestMing As String '用于存放IO卡地址
	Private DiValue As Short '取输入状态值
	Private iPreVal As Short '输入的中间变量
	Private iPreVal1 As Short '输入的中间变量
	Event EventTest(ByRef testPort As System.Array)
	Private WithEvents m_timer As System.Windows.Forms.Timer

	'******************************************************************************
	'** 函 数 名：ShowPortChang
	'** 输    入：
	'** 输    出：IO输入的状态
	'** 功能描述：用于提供外部查询IO输入的状态
	'** 全局变量：
	'** 调用模块：
	'** 作    者：hexiaoqin
	'** 邮    箱：
	'** 日    期：2009-03-05
	'** 修 改 者：
	'** 日    期：
	'** 版    本：1.0
	'******************************************************************************
	Private Sub ShowPortChang()
		Dim raiseE As Boolean
		raiseE = True
		Dim i As Short
		For i = 0 To 15
			If DIWordState(i) <> DIState(i) Then
				raiseE = False
				'       MsgBox "portChang"
			End If
			DIWordState(i) = DIState(i)
		Next i
		If Not raiseE Then
			RaiseEvent EventTest(DIWordState)
		End If
	End Sub

	'******************************************************************************
	'** 函 数 名：IniStallCard
	'** 输    入：
	'** 输    出：
	'** 功能描述：初始化IO卡
	'** 全局变量：
	'** 调用模块：
	'** 作    者：hexiaoqin
	'** 邮    箱：
	'** 日    期：2009-03-05
	'** 修 改 者：
	'** 日    期：
	'** 版    本：1.0
	'******************************************************************************
	Private Sub IniStallCard()
		Dim gnNumOfDevices As Short
		Dim nOutEntries As Short
		Dim i As Object
		Dim ii As Short
		Dim tt As Integer
		Dim tempStr As String

		' Add type of PC Laboratory Card
		'UPGRADE_WARNING: 未能解析对象 devicelist(0) 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
		tt = DRV_GetAddress(0) '扫描设备
		ErrCde = DRV_DeviceGetList(tt, MaxEntries, nOutEntries)
		If (ErrCde <> 0) Then
			DRV_GetErrorMessage(ErrCde, szErrMsg.Value)
			'Response = MsgBox(szErrMsg, vbOKOnly, "Error!!")
			Exit Sub
		End If

		ErrCde = DRV_DeviceGetNumOfList(gnNumOfDevices) '扫描设备号
		If (ErrCde <> 0) Then
			DRV_GetErrorMessage(ErrCde, szErrMsg.Value)
			'Response = MsgBox(szErrMsg, vbOKOnly, "Error!!")
			Exit Sub
		End If

		For i = 0 To (gnNumOfDevices - 1) '扫描设备地址
			tempStr = ""
			For ii = 0 To MaxDevNameLen
				'UPGRADE_WARNING: 未能解析对象 i 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
				tempStr = tempStr & Chr(devicelist(i).szDeviceName(ii))
			Next ii
			TestMing = Mid(tempStr, 1, 16)
			Debug.Print(TestMing)
		Next i
		Call GetDevice()
	End Sub

	'******************************************************************************
	'** 函 数 名：GetDevice
	'** 输    入：
	'** 输    出：
	'** 功能描述：取IO卡的一些参数和设置730
	'** 全局变量：
	'** 调用模块：
	'** 作    者：hexiaoqin
	'** 邮    箱：
	'** 日    期：2009-03-05
	'** 修 改 者：
	'** 日    期：
	'** 版    本：1.0
	'******************************************************************************
	Private Sub GetDevice()
		Dim temp As String
		Dim i As Object
		Dim tempNum As Short
		Dim TestRes As Boolean
		Dim gnNumOfSubdevices As Short
		Dim dwDeviceNum As Integer

		TestRes = TestStr(TestMing, "DEMO")
		If (Not TestRes) Then
			' Check if there is any device attatched on this COM port or CAN
			gnNumOfSubdevices = devicelist(0).nNumOfSubdevices
			If (gnNumOfSubdevices > MaxDev) Then
				gnNumOfSubdevices = MaxDev
			End If

			' retrieve the information of all installed devices

			If (gnNumOfSubdevices = 0) Then
				dwDeviceNum = devicelist(0).dwDeviceNum
				ErrCde = DRV_DeviceOpen(dwDeviceNum, DeviceHandle)
				If (ErrCde <> 0) Then
					DRV_GetErrorMessage(ErrCde, szErrMsg.Value)
					'Response = MsgBox(szErrMsg, vbOKOnly, "Error!!")
					Exit Sub
				Else
					bRun = True
				End If

				'UPGRADE_WARNING: 未能解析对象 lpDevFeatures 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
				ptDevGetFeatures.buffer = DRV_GetAddress(lpDevFeatures)
				ErrCde = DRV_DeviceGetFeatures(DeviceHandle, ptDevGetFeatures)
				If (ErrCde <> 0) Then
					DRV_GetErrorMessage(ErrCde, szErrMsg.Value)
					'Response = MsgBox(szErrMsg, vbOKOnly, "Error!!")
					Exit Sub
				End If
				tempNum = (lpDevFeatures.usMaxDOChl + 7) \ 8
				For i = 0 To (tempNum - 1)
					'UPGRADE_WARNING: 未能解析对象 i 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
					temp = "Port#" & Str(i)
				Next i
			End If
		End If
	End Sub

	'******************************************************************************
	'** 函 数 名：TestStr
	'** 输    入：地址码，状态码
	'** 输    出：
	'** 功能描述：分解出IO卡的当前地址号
	'** 全局变量：
	'** 调用模块：
	'** 作    者：hexiaoqin
	'** 邮    箱：
	'** 日    期：2009-03-05
	'** 修 改 者：
	'** 日    期：
	'** 版    本：1.0
	'******************************************************************************
	Private Function TestStr(ByRef DStr As String, ByRef TStr As String) As Boolean
		Dim lenD As Object
		Dim lenT As Short
		Dim i As Short

		TestStr = False
		'UPGRADE_WARNING: 未能解析对象 lenD 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
		lenD = Len(DStr)
		lenT = Len(TStr)

		'UPGRADE_WARNING: 未能解析对象 lenD 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
		For i = 1 To (lenD - lenT + 1)
			If (Mid(DStr, i, lenT) = TStr) Then
				TestStr = True
			End If
		Next i

		If DStr = "" Then
			TestStr = True
		End If
	End Function

	'******************************************************************************
	'** 函 数 名：GetPortValue
	'** 输    入：IO卡通道号
	'** 输    出：
	'** 功能描述：用于获取IO卡的当前状态值
	'** 全局变量：
	'** 调用模块：
	'** 作    者：hexiaoqin
	'** 邮    箱：
	'** 日    期：2009-03-05
	'** 修 改 者：
	'** 日    期：
	'** 版    本：1.0
	'******************************************************************************
	Private Sub GetPortValue(ByRef PortAddress As Short)
		lpDioPortMode.Port = PortAddress
		lpDioPortMode.dir_Renamed = INPORT
		If lpDevFeatures.usDIOPort > 0 Then
			ErrCde = DRV_DioSetPortMode(DeviceHandle, lpDioPortMode)
			If (ErrCde <> 0) Then
				DRV_GetErrorMessage(ErrCde, szErrMsg.Value)
				'Response = MsgBox(szErrMsg, vbOKOnly, "Error!!")
				Exit Sub
			End If
		End If

		lpDioReadPort.Port = PortAddress
		lpDioReadPort.value = DRV_GetAddress(DiValue)
		ErrCde = DRV_DioReadPortByte(DeviceHandle, lpDioReadPort)
		If (ErrCde <> 0) Then
			DRV_GetErrorMessage(ErrCde, szErrMsg.Value)
			'Response = MsgBox(szErrMsg, vbOKOnly, "Error!!")
			Exit Sub
		End If
		Call UpdateLed(PortAddress, DiValue)
	End Sub

	'******************************************************************************
	'** 函 数 名：ActivateCard
	'** 输    入：IO卡通道号，当前IO卡的状态值
	'** 输    出：
	'** 功能描述：主要用于更新输入状态
	'** 全局变量：
	'** 调用模块：
	'** 作    者：hexiaoqin
	'** 邮    箱：
	'** 日    期：2009-03-05
	'** 修 改 者：
	'** 日    期：
	'** 版    本：1.0
	'******************************************************************************
	Private Sub UpdateLed(ByRef AddressNO As Short, ByRef iValue As Short)
		Dim i As Object
		Dim iShift As Short
		iShift = 1
		If AddressNO = 0 Then
			For i = 0 To 7
				If (iValue And iShift) <> (iPreVal And iShift) Then
					If (iValue And iShift) = iShift Then
						'UPGRADE_WARNING: 未能解析对象 i 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
						DIState(i) = True
					Else
						'UPGRADE_WARNING: 未能解析对象 i 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
						DIState(i) = False
					End If
				End If
				iShift = iShift * 2
			Next 
			iPreVal = iValue
		ElseIf AddressNO = 1 Then 
			For i = 0 To 7
				If (iValue And iShift) <> (iPreVal1 And iShift) Then
					If (iValue And iShift) = iShift Then
						'UPGRADE_WARNING: 未能解析对象 i 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
						DIState(i + 8) = True
					Else
						'UPGRADE_WARNING: 未能解析对象 i 的默认属性。 单击以获得更多信息:“ms-help://MS.VSCC.v90/dv_commoner/local/redirect.htm?keyword="6A50421D-15FE-4896-8A1B-2EC21E9037B2"”
						DIState(i + 8) = False
					End If
				End If
				iShift = iShift * 2
			Next 
			iPreVal1 = iValue
		End If
	End Sub

	Public Sub New()
		MyBase.New()
		Call IniStallCard()
		m_timer = New Timer
		m_timer.Enabled = True
		m_timer.Interval = 100
		m_timer.Start()
	End Sub
	
	Private Sub m_timer_Tick(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles m_timer.Tick
		Call GetPortValue(0)
		Call GetPortValue(1)
		ShowPortChang()
	End Sub
End Class